var fs = require('fs');
var net = require('net');

var port = process.argv[2] || 1976;
var clients = [];

var server = net.createServer(function(socket){
	
	
	clients.push(socket);

	console.log('client Connected');
	server.prefix=socket.remoteAddress+" "+socket.remotePort ;
	
	socket.on('data', function(chunk){

		var msg=chunk.toString();
		if (msg.indexOf('/name')!=-1) {

			server.prefix=msg.substring(6).replace(/(\n|\r)/gm,"");
			msg = socket.remoteAddress + socket.remotePort + ' changed its name to '+ server.prefix+'\n';
		}
		console.log(msg);
		datelog = new Date();
		fs.appendFile('chat.log', datelog.toLocaleString()+' '+server.prefix+' : '+msg, (err)=>{if(err){console.log(err)}});
		clients.forEach(function(socketReturn){
			if (socket !== socketReturn) {
			
			socketReturn.write(server.prefix + ' > '+ msg);
			}
		})
	});
	socket.on('error', function(){
		console.log('client disconnected');
		var index=clients.indexOf(socket);
		clients.splice(index, 1);
		socket.destroy();
	});
});

server.listen(port, function(){
	console.log('Server is listen on port : '+port);
});