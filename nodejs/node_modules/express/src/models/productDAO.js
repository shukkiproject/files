var fs = require('fs');
var sqlite3 = require('sqlite3').verbose();
var ProductDTO = require('./productDTO');
var file="content/myBase.db";
var exists = fs.existsSync(file);	
var db = new sqlite3.Database(file);

function ProductDao(){
	db.serialize(function() {
		if (!exists) {
  			db.run("CREATE TABLE 'products'(" +
                "'product_id'     INTEGER PRIMARY KEY AUTOINCREMENT, " +
                "'product_name'   VARCHAR(75) ," +
                "'product_desc'   TEXT ," +
                "'product_price'  INTEGER ," +
                "'product_image'  TEXT " +
                   
                ");", function(err){
                	if (err!==null) {
                		console.log('Create error : '+err)
                	} else {
                		console.log('SQL table init.')
                	}
            });
  		} else {
  			console.log('table already existed.')
                	}
  		});
}

ProductDao.prototype.findAll = function(callback){
	var productDTOs = [];
	db.all("SELECT product_id,product_name,product_desc,product_price,product_image FROM 'products'", function(err,rows){
			if (err !==null) {
				console.log('Select error'+err);
			} else {
				rows.forEach(function(row){
					var productDTO = new ProductDTO();
						productDTO.setId(row.product_id);
						productDTO.setName(row.product_name);
						productDTO.setPrice(row.product_price);
						productDTO.setDesc(row.product_desc);
						productDTO.setImage(row.product_image);
						productDTOs.push(productDTO);
					});
				callback(err, productDTOs);
				}

			
	});
};

ProductDao.prototype.findOne = function(callback, id){
	var product;
	db.get("SELECT product_id,product_name,product_desc,product_price,product_image FROM 'products' WHERE product_id = ? ", [id], function(err,row){
				console.log(row);
			if (err !==null) {
				console.log('Select error'+err);
			} else {
				
					var productDTO = new ProductDTO();
						productDTO.setId(row.product_id);
						productDTO.setName(row.product_name);
						productDTO.setPrice(row.product_price);
						productDTO.setDesc(row.product_desc);
						productDTO.setImage(row.product_image);
						product=productDTO;
					
				callback(err, product);
				}

			
	});
};

ProductDao.prototype.insert = function(productDTO){
	var sqlRequest = "INSERT INTO 'products' (product_name,product_desc,product_price, product_image)"+"VALUES(?,?,?,?)";
	var stmt = db.prepare(sqlRequest, function(err){
        if(err!== null){
            console.log('Error on instert : '+err)
        }
        else{
            console.log('Insert valid');
        }
    });
    stmt.run(productDTO.getName(),
    	productDTO.getDesc(),
    	productDTO.getPrice(),
    	productDTO.getImage());
    stmt.finalize();
};

ProductDao.prototype.delete = function(id){
	var sqlRequest = "DELETE FROM 'products' WHERE product_id = ? ";
	var stmt = db.prepare(sqlRequest, function(err){
        if(err!== null){
            console.log('Error on delete : '+err)
        }
        else{
            console.log('delete valid');
        }
    });

    stmt.run(id);
    stmt.finalize();
};

    module.exports = new ProductDao();

